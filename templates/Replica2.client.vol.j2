volume {{ gvol.id }}-ta
    type protocol/client
    option transport.socket.read-fail-log false
    option remote-host {{ gvol.tiebreaker_node }}
    option remote-port {{ gvol.tiebreaker_port }}
    option remote-subvolume {{ gvol.tiebreaker_path }}
end-volume

{% for brick in gvol.bricks %}
volume {{ gvol.name }}-client-{{ brick.index }}
    type protocol/client
    option transport.socket.read-fail-log false
    option volfile-key /{{ gvol.name }}
    option remote-subvolume {{ brick.path }}
    option remote-host {{ brick.node }}
end-volume

{% endfor %}

{% for i in range(gvol.dht_subvol|length) %}
volume {{ gvol.name }}-replica-{{ i }}
    type cluster/replicate
    option data-self-heal on
    option granular-entry-heal on
    option iam-self-heal-daemon off
    option metadata-self-heal on
    option entry-self-heal on
    option read-hash-mode 5
    option afr-pending-xattr {{ gvol.name }}-client-{{ i * 2 }},{{ gvol.name }}-client-{{ (i * 2) + 1}},{{ gvol.id }}-ta
    option thin-arbiter {{ gvol.tiebreaker_node }}:{{ gvol.tiebreaker_path }}
    subvolumes {{ gvol.name }}-client-{{ i * 2 }} {{ gvol.name }}-client-{{ (i * 2) + 1}} {{ gvol.id }}-ta
end-volume

{% endfor %}

volume {{ gvol.name }}-dht
    type cluster/distribute
    subvolumes {{ gvol.dht_subvol|join(' ') }}
end-volume

volume {{ gvol.name }}-utime
    type features/utime
    option noatime on
    subvolumes {{ gvol.name }}-dht
end-volume

volume {{ gvol.name }}-md-cache
    type performance/md-cache
    subvolumes {{ gvol.name }}-utime
end-volume

volume {{ gvol.name }}-write-behind
    type performance/write-behind
    option flush-behind on
    option write-behind on
    subvolumes {{ gvol.name }}-md-cache
end-volume

volume {{ gvol.name }}-open-behind
    type performance/open-behind
    option use-anonymous-fd no
    option open-behind on
    option pass-through false
    option read-after-open yes
    option lazy-open yes
    subvolumes {{ gvol.name }}-write-behind
end-volume

volume {{ gvol.name }}-nl-cache
    type performance/nl-cache
    option nl-cache on
    subvolumes {{ gvol.name }}-open-behind
end-volume

volume {{ gvol.name }}
    type debug/io-stats
    subvolumes {{ gvol.name }}-nl-cache
end-volume
