---
# need for docker build
sudo: true
dist: focal

services:
  - docker

language: python
python:
  - "3.7"

branches:
  only:
    - devel

go: 1.12.x

env:
  global:
    - KADALU_VERSION=canary
    - GOLANGCI_VERSION=v1.19.0
    - TEST_COVERAGE=stdout
    - GO_METALINTER_THREADS=1
    - GO_COVER_DIR=_output
    - VM_DRIVER=none
    - CHANGE_MINIKUBE_NONE_USER=true
    - KUBECONFIG=$HOME/.kube/config

install:
  - pip install pylint jinja2

before_script:
  - pylint --version

jobs:
  include:
    - name: pylint tests
      script:
        - pip install requests xxhash grpcio pyxattr kubernetes glustercli
        - make pylint || travis_terminate 1;
    - name: kadalu with kube 1.20.0
      script:
        - sudo apt-get install -y containerd.io=1.2.13-2 docker-ce=5:19.03.11~3-0~ubuntu-$(lsb_release -cs) docker-ce-cli=5:19.03.11~3-0~ubuntu-$(lsb_release -cs)
        - sudo apt-get install -y conntrack
#       - cat <<EOF | sudo tee /etc/docker/daemon.json
# {
#   "exec-opts": ["native.cgroupdriver=systemd"],
#   "log-driver": "json-file",
#   "log-opts": {
#     "max-size": "100m"
#   },
#   "storage-driver": "overlay2"
# }
# EOF
        - sudo mkdir -p /etc/systemd/system/docker.service.d
        - sudo systemctl daemon-reload
        - sudo systemctl restart docker
        - make build-containers || travis_terminate 1;
        - make gen-manifest || travis_terminate 1;
        - tests/setup.sh v1.20.0 || travis_terminate 1;
          ## Pass CLI as an argument, so we can test CLI
        - tests/travis-test.sh v1.20.0 cli || travis_terminate 1;
        - tests/cleanup.sh v1.20.0 || travis_terminate 1;
    - name: kadalu with kube 1.19.2
      script:
        - sudo apt-get install -y containerd.io=1.2.13-2 docker-ce=5:19.03.11~3-0~ubuntu-$(lsb_release -cs) docker-ce-cli=5:19.03.11~3-0~ubuntu-$(lsb_release -cs)
        - sudo apt-get install -y conntrack
        - sudo mkdir -p /etc/systemd/system/docker.service.d
        - sudo systemctl daemon-reload
        - sudo systemctl restart docker
        - make build-containers || travis_terminate 1;
        - make gen-manifest || travis_terminate 1;
        - tests/setup.sh v1.19.2 || travis_terminate 1;
        - tests/travis-test.sh v1.19.2 || travis_terminate 1;
        - tests/cleanup.sh v1.19.2 || travis_terminate 1;
